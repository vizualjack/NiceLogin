<head>
    <style>
        .timelinePage h1 {
            margin: 0;
        }

        .timelinePage input[type=number] {
            width: 3em;
        }

        .timelinePage .newEvent {
            width: 170px;
            margin-left: 50%;
            transform: translateX(-50%);
        }

        .timelinePage .newEvent .time {
            display: flex;
        }

        .timelinePage .newEvent .time span {
            flex-grow: 1;
        }

        .timelinePage .timelineWrapper {
            overflow-y: auto;
        }

        .timelinePage .timelineWrapper .timeline {
            width: 100%;
            height: 500px;
            background-color: lightgray;
            overflow-x: hidden;
            position: relative;
        }

        .timeline .event {
            background-color: lightblue;
            position: absolute;
            width: 100%;
            display: none;
        }
    </style>

    <script>
        var startTimeInput = document.querySelectorAll("input[name=start]");
        var endTimeInput = document.querySelectorAll("input[name=end]");

        var timeline = document.querySelector("div.timeline");
        var eventExample = document.querySelector("div.event");

        var start = new Date();
        var end = new Date();

        async function getEvents(start, end) {
            const response = await fetch("timeline/events", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({start: start, end: end})
            });
            return response.json();
        }

        async function sendNewEvent(text, start, end) {
            const response = await fetch("timeline/create", {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({text: text, start: start, end: end}) 
            });
            return await response.text();
        }

        async function sendRemoveEvent(id) {
            const response = await fetch("timeline/delete", {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({eventId: id}) 
            });
            return response;
        }

        async function loadEvents() {
            start.setHours(0);
            start.setMinutes(0);
            start.setSeconds(0);
            end.setHours(23);
            end.setMinutes(59);
            end.setSeconds(59);

            let pixelForOneMilli = timeline.clientHeight / (end.getTime() - start.getTime());
            let userEvents = await getEvents(start, end);
            userEvents.forEach((event) => {
                let eventStart = new Date(event.start);
                let eventEnd = new Date(event.end);
                
                let eventDuration = eventEnd.getTime() - eventStart.getTime();
                let startDiff = eventStart.getTime() - start.getTime();

                let eventHeight = pixelForOneMilli * eventDuration;
                let eventTop = pixelForOneMilli * startDiff;

                let newEvent = eventExample.cloneNode(true);
                newEvent.innerHTML = event.text;
                newEvent.style.display = "block";
                newEvent.style.height = eventHeight + "px";
                newEvent.style.top = eventTop + "px";
                timeline.append(newEvent);
            });
        }

        async function createNewEventForToday() { 
            let start = new Date();
            start.setHours(startTimeInput[0].value);
            start.setMinutes(startTimeInput[1].value);
            start.setSeconds(0);
            let end = new Date();
            end.setHours(endTimeInput[0].value);
            end.setMinutes(endTimeInput[1].value);
            end.setSeconds(0);

            let res = await sendNewEvent("test", start, end);
            console.log(res);
        }

        loadEvents();
    </script>
</head>

<body>
    <div class="timelinePage">
        <h1>Timeline</h1>
        <div class="newEvent">
            <div class="time">
                <span>Start:</span>
                <input name="start" type="number" max="23">:<input name="start" type="number" max="59">
            </div>
            <div class="time">
                <span>End: </span>
                <input name="end" type="number" max="23">:<input name="end" type="number" max="59">
            </div>
            <span role="button" onclick="createNewEventForToday()">Create</span>
        </div>

        <div class="timelineWrapper">
            <div class="timeline">
                <div class="event"></div>
            </div>
        </div>
    </div>
</body>