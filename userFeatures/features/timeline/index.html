<head>
    <style>
        .timelinePage h1 {
            margin: 0;
        }

        .timelinePage input[type=number] {
            width: 3em;
        }

        .timelinePage .newEvent {
            width: 170px;
            margin-left: 50%;
            transform: translateX(-50%);
        }

        .timelinePage .newEvent .labelInput {
            display: flex;
        }

        .timelinePage .newEvent .labelInput span {
            flex-grow: 1;
        }

        .timelinePage .newEvent input[name=eventName] {
            width: 162px;
        }

        .timelinePage .dateChanger {
            display: flex;
            width: 400px;
            margin: 0 auto;
        }

        .timelinePage .dateChanger span {
            padding: 10px;
            display: block;
        }

        .timelinePage .dateChanger span[role=button] {
            width: 21px;
        }

        .timelinePage .dateChanger .currentDate {
            color: lightblue;
            width: 100%;
            text-align: center;
        }

        .timelinePage .timelineWrapper {
            overflow-y: auto;
            height: 500px;
            width: 450px;
            margin: 5px auto 0 auto;
        }

        .timelinePage .timelineWrapper .timeline {
            width: 100%;
            height: 2000px;
            background-color: rgb(30,30,30);
            overflow-x: hidden;
            position: relative;
        }

        .timeline .currentTimeLine {
            position: absolute;
            display: none;
            width: 100%;
            height: 2px;
            background-color: red;
            z-index: 1;
        }

        .timeline .event {
            background-color: rgba(107, 196, 255, 0.337);
            position: absolute;
            width: 75%;
            display: none;
            padding-left: 5px;
            margin-left: 25%;
            z-index: 2;
        }

        .timeline .timeSeperator {
            display: none;
            position: absolute;
            width: 100%;
        }

        .timeline .timeSeperator span {
            width: 88px;
            margin: -7px 0 0 3px;
            text-align: right;
        }

        .timeline .timeSeperator .line {
            width: 100%;
            height: 2px;
            background-color: white;
            margin-left: 10px;
        }
    </style>

    <script>
        var eventNameInput = document.querySelector("input[name=eventName]");
        var startTimeInput = document.querySelectorAll("input[name=start]");
        var endTimeInput = document.querySelectorAll("input[name=end]");

        var currentDate = document.querySelector(".dateChanger .currentDate");
        var timeline = document.querySelector("div.timeline");
        var eventExample = document.querySelector("div.event");
        var currentTimeLine = document.querySelector(".timeline .currentTimeLine");

        var start = new Date();
        var end = new Date();
        var pixelForOneSec = 0;
        var numOfElementsToSkip = 0;

        async function getEvents(start, end) {
            const response = await fetch("timeline/events", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({start: start, end: end})
            });
            return response.json();
        }

        async function sendNewEvent(text, start, end) {
            const response = await fetch("timeline/create", {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({text: text, start: start, end: end}) 
            });
            return await response.text();
        }

        async function sendRemoveEvent(id) {
            const response = await fetch("timeline/delete", {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({eventId: id}) 
            });
            return response;
        }

        function twoDigits(val) {
            return val < 10 ? ("0" + val) : val;
        }

        function showTimeForDate(date)  {
            return twoDigits(date.getHours()) +  ":" + twoDigits(date.getMinutes());
        }

        function createAndAddEvent(text, eventStart, eventEnd) {
            let eventDuration = (eventEnd.getTime() - eventStart.getTime()) / 1000;
            let startDiff = (eventStart.getTime() - start.getTime()) / 1000;

            let eventHeight = pixelForOneSec * eventDuration;
            let eventTop = pixelForOneSec * startDiff;

            let newEvent = eventExample.cloneNode(true);
            newEvent.innerHTML = text + " (" + showTimeForDate(eventStart) + " - " + showTimeForDate(eventEnd) + ")";
            newEvent.style.display = "block";
            newEvent.style.height = eventHeight + "px";
            newEvent.style.top = eventTop + "px";
            timeline.append(newEvent);
        }

        async function loadEvents() {
            start.setHours(0);
            start.setMinutes(0);
            start.setSeconds(0);
            end.setHours(23);
            end.setMinutes(59);
            end.setSeconds(59);
            
            currentDate.innerHTML = start.toDateString();
            pixelForOneSec = timeline.clientHeight / ((end.getTime() - start.getTime()) / 1000);
            let userEvents = await getEvents(start, end);
            console.log("num of events:" + userEvents.length);
            userEvents.forEach((event) => {
                let eventStart = new Date(event.start);
                let eventEnd = new Date(event.end);
                createAndAddEvent(event.text, eventStart, eventEnd);
            });
        }

        function clearTimeline() {
            for (let i = timeline.childElementCount-1; i > numOfElementsToSkip; i--) {
                let event = timeline.children[i];
                event.remove();
            }
        }

        async function changeDay(changeByDay) {
            start.setDate(start.getDate() + changeByDay);
            end.setDate(end.getDate() + changeByDay);
            clearTimeline();
            loadEvents();
        }

        async function createNewEventForToday() { 
            let eventStart = new Date(start.toDateString());
            eventStart.setHours(startTimeInput[0].value);
            eventStart.setMinutes(startTimeInput[1].value);
            eventStart.setSeconds(0);
            let eventEnd = new Date(end.toDateString());
            eventEnd.setHours(endTimeInput[0].value);
            eventEnd.setMinutes(endTimeInput[1].value);
            eventEnd.setSeconds(0);

            let res = await sendNewEvent(eventNameInput.value, eventStart, eventEnd);
            if(res) {
                createAndAddEvent(eventNameInput.value, eventStart, eventEnd);
                startTimeInput[0].value = "";
                startTimeInput[1].value = "";
                endTimeInput[0].value = "";
                endTimeInput[1].value = "";
                eventNameInput.value = "";
            }
        }

        function showCurrentTime() {
            if(pixelForOneSec == 0) return;
            let currentTime = new Date();
            if(currentTime.toDateString() !== start.toDateString()) {
                currentTimeLine.style.display = "none";
                return;
            }
            let currentTimeDiff = (currentTime.getTime() - start.getTime()) / 1000;
            let currentTimeLineTop = currentTimeDiff * pixelForOneSec;

            currentTimeLine.style.display = "block";
            currentTimeLine.style.top = currentTimeLineTop + "px";
        }

        function createTimeSeperator() {
            let timeSeperatorExample = document.querySelector(".timeline .timeSeperator");
            let time = new Date();
            time.setHours(0);
            time.setMinutes(30);
            do {
                let timeSeperator = timeSeperatorExample.cloneNode(true);
                timeSeperator.style.display = "flex";
                timeSeperator.children[0].innerHTML = showTimeForDate(time);

                let startDiff = (time.getTime() - start.getTime()) / 1000;
                let timeSeperatorTop = pixelForOneSec * startDiff;

                timeSeperator.style.top = timeSeperatorTop + "px";
                timeline.append(timeSeperator);
                time.setMinutes(time.getMinutes() + 30);
            } while(time.getHours() != 0 || time.getMinutes() != 0);

            numOfElementsToSkip = timeline.childElementCount;
        }
        
        function initFeature() {
            loadEvents();
            createTimeSeperator();
            window.setInterval(showCurrentTime, 1000);
        }
    </script>
</head>

<body>
    <div class="timelinePage">
        <h1>Timeline</h1>
        <div class="newEvent">
            <span>Event-Text:</span>
            <input name="eventName">
            <div class="labelInput">
                <span>Start:</span>
                <input name="start" type="number" max="23">:<input name="start" type="number" max="59">
            </div>
            <div class="labelInput">
                <span>End: </span>
                <input name="end" type="number" max="23">:<input name="end" type="number" max="59">
            </div>
            <span role="button" onclick="createNewEventForToday()">Create</span>
        </div>

        <div class="dateChanger">
            <span role="button" onclick="changeDay(-1)"><</span>
            <span class="currentDate">date here</span>
            <span role="button" onclick="changeDay(1)">></span>
        </div>
        <div class="timelineWrapper">
            <div class="timeline">
                <div class="currentTimeLine"></div>
                <div class="event"></div>
                <div class="timeSeperator">
                    <span>12:00</span>
                    <div class="line"></div>
                </div>
            </div>
        </div>
    </div>
</body>